<!DOCTYPE html>
<html>

<head>
    <title>Tamagochi_v1 Transaction Analyzer</title>
    <style>
        body {
            font-family: sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
        }

        input,
        button {
            padding: 10px;
            border-radius: 5px;
            border: none;
        }

        input {
            width: 70%;
            background: #0f3460;
            color: white;
        }

        button {
            background: #e94560;
            color: white;
            cursor: pointer;
        }

        #results {
            margin-top: 20px;
            background: #0f3460;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }

        .success {
            color: #2ecc71;
        }

        .error {
            color: #e74c3c;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Tamagochi_v1 Analyzer</h1>
        <p>Enter a Transaction ID to see if it contains a Tamagochi_v1 contract and its state.</p>
        <input type="text" id="txId" placeholder="Enter TXID...">
        <button onclick="analyzeTx()">Analyze</button>
        <div id="results">Output will appear here...</div>
    </div>

    <!-- Load needed libraries from the local directory -->
    <script src="scrypt_bundle.js"></script>

    <script>
        const results = document.getElementById('results');
        const log = (msg, className = '') => {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            if (className) div.className = className;
            results.appendChild(div);
            console.log(msg);
        };

        async function analyzeTx() {
            const txId = document.getElementById('txId').value.trim();
            if (!txId) return alert("Enter TXID");

            results.innerHTML = '';
            log(`Fetching TX ${txId}...`);

            try {
                // Load Artifact first
                const artResp = await fetch('Tamagochi_v1.json');
                const artifact = await artResp.json();

                const bundle = window.ScryptBundle || {};
                const GameContract = window.GameContract || bundle.GameContract;
                const scrypt = window.scrypt || bundle.scrypt;

                if (!GameContract) throw new Error("GameContract not found in bundle");

                GameContract.loadArtifact(artifact);
                log("Artifact loaded.", "success");

                // Fetch Hex
                const hexResp = await fetch(`https://api.whatsonchain.com/v1/bsv/main/tx/${txId}/hex`);
                if (!hexResp.ok) throw new Error("Failed to fetch TX hex");
                const hex = await hexResp.text();
                log("Transaction hex fetched.");

                const bsvTx = new scrypt.bsv.Transaction(hex);
                log(`Transaction has ${bsvTx.outputs.length} outputs.`);

                let found = false;
                for (let i = 0; i < bsvTx.outputs.length; i++) {
                    try {
                        const instance = GameContract.fromTx(bsvTx, i);
                        if (instance) {
                            found = true;
                            log(`FOUND contract in Output ${i}!`, "success");
                            log(`- State: ${instance.packedGameState}`);

                            // Try to unpack state if we have the helper
                            try {
                                // Simple manual unpack for debug if needed, but let's see if artifact methods work
                                log(`- Player: ${instance.playerPubKeyHash}`);
                                log(`- Genesis ID: ${instance.genesisTxId || "N/A"}`);
                                if (instance.factoryAddress) log(`- Factory: ${instance.factoryAddress}`);
                            } catch (e) {
                                log(`- Error reading properties: ${e.message}`);
                            }
                        }
                    } catch (e) {
                        // Not this output
                    }
                }

                if (!found) {
                    log("Contract NOT FOUND in any output of this transaction.", "error");
                }

            } catch (e) {
                log(`Error: ${e.message}`, "error");
                console.error(e);
            }
        }
    </script>
</body>

</html>